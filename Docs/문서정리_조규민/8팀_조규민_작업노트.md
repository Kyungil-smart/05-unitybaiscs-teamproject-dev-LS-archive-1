# 8팀_조규민_작업노트

> 환경 연출(안개/비/지진) 시스템을 **단발 실행(PlayOnce)** + **반복 운용(랜덤 루프)** 할 수 있게 정리하고,  
> 최종적으로 `EnvGimmickManager`에서 **한 번에 1개만** 돌아가도록 통합 제어하는 흐름으로 구성했다.

---

## 2026-01-27 — FogSystem 구현

### 1) 기능
- **지역(Zone) 안개 연출**: 파티클 기반 `Fog_zone` 프리팹을 사용해 “구역 전체에 퍼져있는 안개” 느낌을 만든다.
- **자연스러운 등장/퇴장**: `Fade In → Hold → Fade Out` 흐름으로 “툭 생기는 느낌”을 방지한다.
- **재사용 구조**: `FogRandomLoop`가 `Fog_zone`을 **Instantiate 1회** 후 재사용하며, 필요 시 **1회 실행(PlayOnce)** 도 가능.
- **추적 옵션(선택)**: `spawnAnchor`를 지정하면 연출 중에 해당 위치를 따라다니게 설정 가능(`followAnchorWhileActive`).
- **잔상/중첩 방지**: 종료 시 `StopEmittingAndClear`로 남은 파티클까지 정리.

### 2) 코드 설명
- **인스턴스 1회 생성 + 기준값 캐싱**
  - `CreateOrReuseInstance()`에서 `ParticleSystem`, `ParticleSystemRenderer`를 찾아 캐싱하고,
  - Emission/Color의 “기준값(base)”를 저장해두었다가 intensity로 스케일한다.
- **Fade/Hold 코루틴**
  - `Fade(from,to,seconds)`에서 intensity를 보간하며 매 프레임 `ApplyIntensity()`를 호출.
  - `Hold(intensity,seconds)`는 해당 강도를 유지하며(옵션으로) 앵커 추적.
- **intensity(0~1) → 밀도 + 투명도 동기화**
  - 핵심은 `ApplyIntensity()`에서 **Emission(밀도)** 과 **알파(투명도)** 를 동시에 반영하는 것.

```csharp
// intensity(0~1)를 Emission + 알파에 동시에 적용
private void ApplyIntensity(float intensity)
{
    intensity = Mathf.Clamp01(intensity);

    // 1) Emission 스케일
    var rot = baseRateOverTime;
    rot.constant *= intensity;
    rot.constantMin *= intensity;
    rot.constantMax *= intensity;
    rot.curveMultiplier *= intensity;
    ps.emission.rateOverTime = rot;

    // 2) startColor 알파(상수색일 때)
    if (hasConstantStartColor)
    {
        Color c = baseStartColor;
        c.a = baseStartColor.a * intensity;
        ps.main.startColor = c;
    }

    // 3) 머티리얼 알파(MaterialPropertyBlock로 렌더러 단위 덮어쓰기)
    // (_Color / _TintColor 지원)
}
```

### 3) 세팅/사용법(추가)
- `FogRandomLoop`를 빈 오브젝트에 붙이고 **fogPrefab에 `Fog_zone`** 을 연결.
- `runLoopOnStart = false` 권장(매니저로 제어할 때). 단독 사용 시 true로 켜도 됨.
- `spawnAnchor`를 지정하면 플레이어/카메라 기준으로 “따라오는 안개” 연출도 가능.
- 튜닝 포인트:
  - `peakIntensityRange`(최대 강도), `fadeIn/hold/fadeOutRange`(시간감)
  - 파티클 프리팹의 `Emission rate`, `Shape(Box) 범위`, `Max Particles`

### 4) 테스트 체크(추가)
- 씬 시작 시 잔상이 남지 않는지(StopEmittingAndClear 확인)
- 페이드 인/아웃이 “끊김” 없이 자연스러운지(알파/밀도 동기화)
- 추적 옵션 사용 시 위치가 튀지 않는지(`followUpdateInterval`로 부담 조절)

---

## 2026-01-28 — RainSystem 구현

### 1) 기능
- **비 연출 프리팹**: 파티클 기반으로 넓은 Box 영역에서 빗줄기가 떨어지도록 구성.
- **레이어 분리**: 빗줄기(Rain) + 바닥 디테일(splash)을 분리해 튜닝 용이.
- **단발 실행(PlayOnce)**: `RainRandomLoop`에서 일정 시간 랜덤 유지 후 종료.
- **부가 효과(게임플레이)**: 파티클 충돌 시 플레이어 이동 속도를 **일정 시간 감속**.

### 2) 코드 설명
- **전체 파티클 일괄 제어**
  - `particleRoot` 아래의 모든 `ParticleSystem`을 캐싱해서 한 번에 Play/Stop.
- **OnParticleCollision 기반 감속**
  - `Collision 모듈`의 `Send Collision Messages`가 켜져 있어야 동작.
  - 맞은 오브젝트에서 `ThirdPersonRigidbodyController`를 찾아 감속 적용.
  - 이동 속도 변경은 Reflection(`walkSpeed`, `runSpeed`)로 처리(필드명 변경 시 비활성화).

```csharp
public IEnumerator PlayOnce()
{
    CacheParticles();
    foreach (var ps in allPS) ps.Play(true);

    yield return new WaitForSeconds(RandomRange(activeDurationRange));
    ForceStop();
}

private void OnParticleCollision(GameObject other)
{
    var hitCtrl = other.GetComponentInParent<ThirdPersonRigidbodyController>();
    if (hitCtrl == null) return;

    BindIfNeeded(hitCtrl);          // Reflection 캐싱(walkSpeed/runSpeed)
    ApplySlowAndRefreshTimer();     // 감속 + 타이머 갱신
}
```

### 3) 세팅/사용법(추가)
- `RainRandomLoop`를 **비 파티클 루트 오브젝트**에 붙이거나, `particleRoot`를 지정.
- 충돌 감속을 쓰려면:
  - 파티클 `Collision`에서 **Send Collision Messages** ON
  - 감속 대상 오브젝트 태그(`targetTag`) 확인(기본 Player)
- 튜닝 포인트:
  - 비 강도: 파티클 `Emission rateOverTime`
  - 감속 강도: `slowMultiplier`, 유지시간: `slowDuration`

### 4) 리스크/개선 메모(추가)
- Reflection 기반이라 `ThirdPersonRigidbodyController`의 필드명이 바뀌면 동작이 깨질 수 있음  
  → 이후 개선 시 **public API(메서드/프로퍼티)** 또는 **인터페이스**로 교체 고려.

---

## 2026-01-29 — ShakingSystem 구현

### 1) 기능
- **지진 연출 프리팹**: 카메라 흔들림 + 맵(리짓바디) 흔들림을 **한 번의 연출**로 묶음.
- **자연스러운 강도 흐름**: `Fade In → Hold → Fade Out` 기본 구조 + 각 구간 랜덤 범위.
- **반복 패턴 감소**
  - 강도/시간/속도를 Range로 랜덤화
  - 카메라는 PerlinNoise 기반으로 부드러운 흔들림 연결
- **맵 흔들림 모드**
  - `Auto`: kinematic이면 `MovePosition`, 아니면 `velocity` 적용
  - 축 선택(X/Z) 지원
- **자동 수집 옵션**
  - `mapRigidbodyRoot` 하위 Rigidbody 자동 등록(`autoCollectFromRoot`)

### 2) 코드 설명
- **카메라( LateUpdate )**
  - 다른 스크립트의 움직임 이후에 오프셋을 얹기 위해 `LateUpdate`에서 적용.
  - 이전 프레임 오프셋을 먼저 제거해 누적(드리프트) 방지.

```csharp
private void LateUpdate()
{
    RemoveCameraLastOffset();                 // 누적 방지

    if (!quakeActive || currentIntensity <= 0f) return;

    float t = Time.time * quakeCameraFrequency;
    float nx = (Mathf.PerlinNoise(t + quakeSeed, 0.17f) - 0.5f) * 2f;

    camLastPosOffset = new Vector3(nx, 0f, 0f) * (cameraMaxPosOffset * currentIntensity);
    cameraShakeTarget.localPosition += camLastPosOffset;
}
```

- **맵( FixedUpdate )**
  - Rigidbody 조작은 물리 틱에 맞춰 `FixedUpdate`에서 처리.
  - `Auto` 모드에서 kinematic 여부에 따라 `MovePosition` / `velocity` 분기.

### 3) 세팅/사용법(추가)
- 멀미 방지/튜닝:
  - 회전 흔들림이 부담이면 `shakeCameraRotation` OFF 또는 `cameraMaxRotAngle` 낮추기
- 맵 흔들림:
  - 흔들 대상을 직접 리스트에 넣거나 `mapRigidbodyRoot` 지정 후 자동 수집 사용
- 매니저 연동 시:
  - `autoPlayOnStart = false`로 두고, 매니저에서 `PlayOnce()` 호출 방식 권장.

### 4) 종료 처리(추가)
- `OnDisable()`에서 코루틴 종료 + 즉시 복구(`EndQuakeImmediate`)로 씬 전환/비활성 시 잔상 방지.
- 매니저에서 중첩 방지 시 `StopLoop()` 호출.

---

## 2026-01-30 — EnvGimmickManager 제작

### 1) 기능
- **환경 기믹 통합 제어**: 안개/비/지진을 한 매니저에서 운영.
- **동시 재생 금지**: 한 시점에는 **1개만** 재생되도록 시작 전/끝난 직후 모두 `StopAll()`.
- **자연스러운 간격 운영**: `firstDelayRange`, `intervalRange`로 첫 실행/다음 실행 간격을 랜덤화.
- **체감 랜덤 개선(셔플백)**
  - 3종 기믹을 한 라운드에 한 번씩 나오게 셔플백 구성
  - 옵션으로 라운드 경계 연속 중복(마지막 → 다음 첫 번째) 완화

### 2) 코드 설명
- **실행 루프**
  - `OnEnable()`에서 Loop 코루틴 시작
  - `StopAll()`로 정리 → 선택된 기믹 `PlayOnce()` 실행 → 종료 직후 다시 정리 → 간격 대기

```csharp
private IEnumerator Loop()
{
    yield return new WaitForSeconds(RandomRange(firstDelayRange));

    while (true)
    {
        int idx = Draw();        // 셔플백에서 0/1/2 선택

        StopAll();               // 시작 전 정리
        yield return Play(idx);  // 1개 실행(끝날 때까지 대기)
        StopAll();               // 끝난 직후 정리(중첩 방지)

        yield return new WaitForSeconds(RandomRange(intervalRange));
    }
}
```

- **셔플백(Draw)**
  - bag이 비면 `[0,1,2]` 채우고 Shuffle.
  - `avoidSameAcrossRounds`가 켜져 있으면 `bag[0] == lastIndex`일 때 첫 두 요소 스왑.

### 3) 세팅/사용법(추가)
- 씬에 빈 오브젝트 생성 → `EnvGimmickManager` 부착 → 아래 3개 레퍼런스 연결:
  - `FogRandomLoop`, `RainRandomLoop`, `ShakingRandomLoop`
- 각 기믹 스크립트는 **자체 루프 자동 실행 옵션을 꺼두고**(가능하면),
  매니저에서 `PlayOnce()`로만 돌리는 구성이 가장 깔끔함.
- 중첩 방지 정책이 “강제 종료(StopEmittingAndClear)” 형태라,
  연출이 겹치면 잔상이 남기 쉬운 씬에서 특히 유효.

---

## 메모(운영/디버깅)
- **테스트 순서 권장**
  1) 각 기믹 단독(PlayOnce)으로 정상 작동 확인  
  2) 매니저 연결 후 “한 번에 1개만” 잘 도는지 확인  
  3) 씬 비활성/재시작 시 잔상(파티클/카메라 오프셋/리짓바디 속도) 남는지 확인
- **개선 후보**
  - Rain의 감속 처리: Reflection 대신 PlayerController에 명시적 API 제공
  - Fog의 머티리얼 알파: baseAlpha * intensity 방식으로 더 자연스러운 유지 가능


