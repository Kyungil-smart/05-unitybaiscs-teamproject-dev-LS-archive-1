# OverTheSky_R&D 문서
작성자: 이성규

게임명: OverTheSky

## 개요

프로젝트 진행 전 구현 방식과 예상되는 기술적 과제에 대한 사전 연구 및 설계 문서.

---

## 핵심 설계 방향

### 제약사항
피직스 머티리얼 및 캐릭터 컨트롤러는 학습 진도가 아니니 구현에 있어 사용에서 제외했다.

### 예상되는 문제점
이 경우 생기는 난점은 벽뚫기 현상의 가능성이 대폭 증가하며 경사로(Slope)의 기울기나 계단의 Step Offset 같은 기능을 직접 구현하지 않는 이상 벽처럼 가로막혀 못올라갈 수 있다.   

또한 덜덜거림 (Jittering)이 발생하는데 OnCollisionEnter로 충돌을 처리하려고 하면, 캐릭터가 벽이나 바닥에 닿을 때마다 물리 엔진과 코드 사이의 충돌로 인해 화면이 미세하게 떨리는 현상을 잡기 매우 어렵다.

### 해결 방향
대신 플레이어가 땅에 닿으면 중력을 끄고 점프하거나 떨어질때. 혹은 충돌등 특별한 이벤트가 있을시 켜주는 식으로 진행한다.

플레이어 아래로 레이를 쏴서 충돌체의 노말 정보로 기울기 정보를 얻고 ProjectOnPlane을 통해 이동하려는 방향을 바닥 기울기에 맞춰서 비스듬하게 바꾼다. 그리고 경사로 이동 방향으로 힘을 가하거나 위치 이동을 하는데 MovePosition을 쓰면 벽 뚫기 방지에 유리하다.

---

## Rigidbody 설정

또한 리지드바디 설정도 조절해줄 필요가 있다.

### 권장 설정값
- **Mass**: 1 (기본)
- **Drag**: 아주 높은 값 (10~20)
  - 이 값을 높이면 공기 저항이 세져서 이동 키를 떼는 순간 제자리에 딱 멈춘다. 피직스 머티리얼의 마찰력(Friction) 효과를 대체할 수 있다.
  - 땅에 있으면 높은 Drag, 공중에선 낮은 Drag
- **Angular Drag**: 0
- **Use Gravity**: False (중력도 코드로 제어해야 깔끔함, 혹은 True로 쓰되 Drag 조절 필수)
- **Constraints**: Freeze Rotation X, Y, Z 체크 (캐릭터가 공처럼 구르면 안 됨)
- **Interpolate**: Interpolate (부드러운 움직임)

### 동적 제어 필요 사항
다만 Drag도 공중과 땅 상태에 따라 동적으로 컨트롤 필요.

SmoothDamp를 통한 부드러운 이동 구현시 현재 이동 벡터를 목표 벡터까지 smoothTime 동안 부드럽게 변화시킨다.

---

## 이동 구현 방식 검토

### MovePosition vs Velocity

#### MovePosition 방식
- Y축은 물리 엔진이 계산한 값을 유지 (중력)
- MovePosition을 쓰더라도 Y축 변화량을 반영해야 점프가 됨
- 하지만 MovePosition은 물리 위치를 강제하므로, 수평 이동만 여기서 처리하고 수직 이동은 Rigidbody의 Velocity를 믿는 게 충돌 처리에 유리함.
- 가장 안정적인 방식: 수평 속도만 MovePosition으로 밀어넣기
- (단, 벽 비비기 문제를 위해 MovePosition 사용 시 주의 필요)

#### Velocity 방식 (채택)
- Rigidbody.velocity 사용도 고려.
- Rigidbody의 Collision Detection을 Continuous로 설정
- FixedUpdate에서 이동하려는 방향으로 CapsuleCast를 미리 쏴서, 벽이 있다면 속도(Velocity)를 0으로 죽이는 로직을 추가

**결론**: Velocity + ProjectOnPlane 조합을 통해 구현 난이도를 하락시키는게 합리적이라 판단. MovePosition은 예외 처리 계산이 많아 구현 난이도가 어렵고 개발 기간에 비해 합리적이지 않고 리스크가 크다.

---

## 핵심 로직 흐름

1. **입력**: WASD 입력을 받는다.
2. **경사 보정**: ProjectOnPlane으로 바닥 기울기에 맞춰 벡터를 꺾는다.
3. **속도 적용**: X, Z축 속도를 목표 속도로 덮어쓴다 (Y축은 유지).
4. **정지**: 입력이 없으면 높은 Drag가 알아서 멈춰준다.

---

## 예상 이슈 및 해결책

### 1. 움직이는 발판에서 미끄러짐

**문제:**
플레이어가 움직이는 발판 위에 올라타도, 발판과 같이 움직이지 않고 발판만 쑥 빠져나가 버린다. (플레이어의 속도를 코드가 강제로 0이나 걷는 속도로 고정해버리기 때문)

**해결책:**
"발판의 속도"를 더해줘야 한다
- 내 걷는 속도 + 발판이 움직이는 속도

---

### 2. 급경사 등반

**문제:**
ProjectOnPlane은 수학적으로 벡터를 투영할 뿐 이 경사가 가파르다는 판단이 없다.

**해결책:**
각도 제한(Slope Limit) 로직을 추가해준다.
- 각도 제한보다 가파르면 이동 불가 (혹은 미끄러지게)
- 이동 벡터를 0으로 만들거나, 중력만 받게 함

---

### 3. 천장에 머리 박고 안 떨어짐

**문제:**
천장에 닿아도 바닥 취급으로 Drag 값이 커질 수 있다.

**해결책:**
위쪽으로 레이캐스트를 쏴서 천창이 감지되면 강제로 떨구는 처리 해주기.

천장인지 바닥인지 체크하는 방법은 충돌한 표면이 하늘을 보고 있는지, 바닥을 보고 있는지만 확인하면 된다.

#### "각도(Normal.y)"로 천장과 바닥 가려내기
- **바닥(Floor)**: 표면의 Normal.y 값이 양수(+) / (보통 0.7 이상이면 평지)
- **천장(Ceiling)**: 표면의 Normal.y 값이 음수(-)
- **벽(Wall)**: 표면의 Normal.y 값이 0에 가깝다.

```cs
float slopeAngle = Vector3.Angle(groundNormal, Vector3.up);
```
상기의 코드를 통해 값을 얻는 것을 고려.

---

### 4. 내리막길에서 공중부양

**문제:**
ProjectOnPlane을 통한 구현은 오르막길에서는 문제가 없지만 내리막길을 빠르게 내려갈 때 공중으로 붕뜨는 문제가 생길 수 있다.

**해결책:**
- isGrounded 상태이고, Jump를 하지 않은 상황이라면
- 강제로 바닥 쪽으로 누르는 힘을 지속적으로 줘야 한다. (마치 중력처럼)
- 기본 적용 중력으로 해결되지 않고 해당 이슈가 발생한다면 구현 고려

---

### 5. 모서리에서 미끄러짐

**문제:**
Raycast로 바닥을 체크하지만 캡슐 콜라이더의 밑부분은 둥글다는 점이 문제

**해결책:**
- Physics.SphereCast를 통해 바닥이나 벽 체크 판정을 개선하고 확실히 해준다.
- 벽면 체크는 CapsuleCast로 판정 개선

---

### 6. Step Offset 미구현으로 계단을 못올라감

**문제:**
계단이나 턱을 올라가지 못하는 현상

**해결책 1 (게임 디자인):**
- 어렵게 구현하기보단 점프를 자주해야되는 불편한 온리업 게임 특유의 조작감으로 남길 수도 있다.

**해결책 2 (기술적):**
- ProjectOnPlane이 있으니 오브젝트 콜라이더를 Mesh Collider convex 기능을 사용해 비스틈한 충돌체로 만들어 해결할수도 있다.

---

## 캐릭터 컨트롤러 실제 구현 후기

문서를 쓸 때는 **"유니티 기본 기능(Drag)"**에 의존하려 했으나, 실제 코딩 과정에서 **"직접 제어(Code Control)"**로 선회하여 퀄리티를 높였다.

- 정지 방식: High Drag -> Code Brake
  - 문서 계획: Drag를 10~20으로 높여서 공기 저항으로 멈추기
  - 실제 구현: "입력이 없으면 velocity = 0으로 강제 고정(주차 브레이크)."

- 마찰 처리: Drag 조절 -> Frictionless Material
  - 문서 계획: 피직스 머티리얼은 안 쓰고 Drag로 해결.
  - 실제 구현: 마찰력 0인 피직스 머티리얼을 코드로 생성해서 적용.
- 내리막길 처리: Force -> Velocity Fixing
  - 문서 계획: 바닥 쪽으로 누르는 힘(Force)을 준다
  - 실제 구현: 경사면에서는 중력 가속도를 0으로 고정하고 그렇지 않으면 -2f로 유지.

- 추가된 디테일
  - 입력 버퍼 (Input Buffer): 문서에는 단순히 "입력을 받는다"고만 되어 있었으나, 실제로는 InputManager를 통해 선입력을 처리하여 점프 씹힘을 방지했다.
  - 벽 반동 (Wall Kick): 문서의 "급경사 등반 문제"를 해결하기 위해, 단순히 막는 것을 넘어 **"뒤로 튕겨내는 액션"**을 추가하여 꼼수를 막고 조작감을 살렸다.
  - 코요테 타임: 문서엔 없었지만 PlayerBase에 _lastGroundedTime을 구현하여 낙하 직전 점프를 허용했다.


---

**작성일**: 2026-01-26  
**최종 수정**: 2026-01-30